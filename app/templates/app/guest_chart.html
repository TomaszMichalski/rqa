{% extends "app/base.html" %} {% block content %}

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/0.5.7/chartjs-plugin-annotation.js"></script>

<div id="content">
    <div class="container">
        <br />
        <br />
        <div class="row">
            <div class="col-sm-9">
                <div id="chart_title">
                    <h3>{{ chart_title }}</h3>
                </div>
                <center>
                    <br /><br />
                    <div id="loader"></div>
                </center>
                <div id="chart">
                    <canvas id="pm1" width="800" height="200"></canvas>
                    <canvas id="pm25" width="800" height="200"></canvas>
                    <canvas id="pm10" width="800" height="200"></canvas>
                    <canvas id="temperature" width="800" height="200"></canvas>
                    <canvas id="pressure" width="800" height="200"></canvas>
                    <canvas id="humidity" width="800" height="150"></canvas>
                    <canvas id="wind_speed" width="800" height="150"></canvas>
                    <canvas id="wind_degree" width="800" height="150"></canvas>
                    <canvas id="clouds" width="800" height="150"></canvas>
                </div>
            </div>
            <div class="col-sm-3">
                <div id="side-panel">
                    <div id="buttons" class="row">
                        <a href="#" id="btn-refresh" class="btn btn-primary btn-block" role="button">Refresh</a>
                        <br />
                        <a href="#" id="btn-export" class="btn btn-primary btn-block" role="button" download="{{ filename }}">Export</a>
                    </div>
                    <div id="description" class="row">
                        <h4>Information</h4>
                        <div id="info"></div>
                        <br />
                        <table id="stats" class="table table-bordered table-sm">
                            <tr>
                                <th><center>Factor</center></th>
                                <th><center>Mean</center></th>
                                <th><center>Median</center></th>
                                <th><center>Standard deviation</center></th>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">
    function csrfSafeMethod(method) {
        // these HTTP methods do not require CSRF protection
        return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
    }

    document.getElementById('btn-email').disabled = true;
    document.getElementById('btn-refresh').disabled = true;
    document.getElementById('btn-export').disabled = true;
    document.getElementById('btn-email').setAttribute("disabled", "");
    document.getElementById('btn-refresh').setAttribute("disabled", "");
    document.getElementById('btn-export').setAttribute("disabled", "");

    var canvases = [document.getElementById('pm1'),
        document.getElementById('pm25'),
        document.getElementById('pm10'),
        document.getElementById('temperature'),
        document.getElementById('pressure'),
        document.getElementById('humidity'),
        document.getElementById('wind_speed'),
        document.getElementById('wind_degree'),
        document.getElementById('clouds')];

    $.ajaxSetup({
        beforeSend: function(xhr, settings) {
            if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                xhr.setRequestHeader("X-CSRFToken", '{{ csrf_token }}');
            }
            $('#loader').show();
        }
    });

    $.ajax({
        type: 'post',
        url: '{% url "async_prediction" %}',
        data: JSON.stringify(JSON.parse('{{ parameters | escapejs }}')),
        dataType: 'json',
        contentType: 'application/json',
        complete: function() {
            $('#loader').hide();
        },
        success: function(response) {
            response = JSON.parse(response);
            drawData(response.data, response['prediction_offset'], response['enable_heavy_computing']);
            fillInfo(response.info);
            if (hasHistoricalData(response.data)) {
                fillStats(response.stats.historical, 'historical_stats');
            } else {
                hideHistoricalStats();
            }
            if (response['enable_heavy_computing']) {
                fillStats(response.stats.fbprophet, 'fbprophet_stats');
            } else {
                hideHeavyComputingStats();
            }
            fillStats(response.stats.linreg, 'linreg_stats');
            enableButtons();
        },
        error: function(XMLHttpRequest, textStatus, errorThrown) {
            alert("There was an error while collecting data. Please try again later");
        }
    });

    function hasHistoricalData(data) {
        var historicalData = data.historical;
        var factors = Object.keys(historicalData);
        for (var i = 0; i < factors.length; i++) {
            if (Object.values(historicalData[factors[i]]).length != 0) {
                return true;
            }
        }

        return false;
    }

    function hideHistoricalStats() {
        document.getElementById("historical_stats_header").style.display = "none";
        document.getElementById("historical_stats").style.display= "none";
    }

    function hideHeavyComputingStats() {
        document.getElementById("fbprophet_stats_header").style.display = "none";
        document.getElementById("fbprophet_stats").style.display= "none";
    }

    function mergeLabels(data, factor) {
        first = [];
        second = [];
        if (Object.keys(data.historical).includes(factor)) {
            first = Object.keys(data.historical[factor]);
        }
        if (Object.keys(data.linreg).includes(factor)) {
            second = Object.keys(data.linreg[factor]);
        }

        return first.concat(second);
    }

    function hasData(data, factor, enableHeavyComputing) {
        if (enableHeavyComputing) {
            return Object.keys(data.historical).includes(factor) && Object.keys(data.historical[factor]).length != 0 || 
                    Object.keys(data.fbprophet).includes(factor) && Object.keys(data.fbprophet[factor]) != 0 || 
                    Object.keys(data.linreg).includes(factor) && Object.keys(data.linreg[factor]).length != 0;
        } else {
            return Object.keys(data.historical[factor]).length != 0 || 
                    Object.keys(data.linreg).includes(factor) && Object.keys(data.linreg[factor]).length != 0;
        }
    }

    function applyPredictionOffset(data, offset) {
        return Array(offset).fill(null).concat(data);
    }

    function getDatasets(data, factor, predictionOffset, enableHeavyComputing) {
        datasets = [];
        if (Object.keys(data.historical).includes(factor)) {
            datasets.push({
                        label: 'Historical data',
                        data: Object.values(data.historical[factor]),
                        fill: false,
                        backgroundColor: 'rgb(255, 128, 0)',
                        borderColor: 'rgb(255, 128, 0)'
                    });
        }
        if (Object.keys(data.linreg).includes(factor)) {
            datasets.push({
                        label: 'Trend analysis prediction',
                        data: applyPredictionOffset(Object.values(data.linreg[factor]), predictionOffset),
                        fill: false,
                        backgroundColor: 'rgb(153, 153, 0)',
                        borderColor: 'rgb(153, 153, 0)'
                    });
        }
        if (enableHeavyComputing && Object.keys(data.fbprophet).includes(factor)) {
            datasets.push({
                        label: 'FBProphet prediction',
                        data: applyPredictionOffset(Object.values(data.fbprophet[factor]), predictionOffset),
                        fill: false,
                        backgroundColor: 'rgb(51, 51, 255)',
                        borderColor: 'rgb(51, 51, 255)'
                    });
        }

        return datasets;
    }

    function drawData(data, predictionOffset, enableHeavyComputing) {
        /* Hide unused canvas */
        canvases.map(c => c.style.display = hasData(data, c.id, enableHeavyComputing) ? "block" : "none")

        /* PM1 */
        var pm1 = new Chart(document.getElementById('pm1'), {
            type: 'line',
            data: {
                labels: mergeLabels(data, 'pm1'),
                datasets: getDatasets(data, 'pm1', predictionOffset, enableHeavyComputing)
            },
            options: {
                legend: {
                    display: false
                },
                responsive: true,
                title: {
                    display: true,
                    text: 'PM1'
                },
                tooltips: {
                    mode: 'index',
                    intersect: true
                },
                scales: {
                    xAxes: [{
                        type: 'time',
                        distribution: 'linear',
                        time: {
                            unit: 'day'
                        }
                    }],
                    yAxes: [{
                        scaleLabel: {
                            display: true,
                            labelString: 'PM1 (\xB5g/m\xB3)'
                        },
                        ticks: {
                            beginAtZero: true
                        }
                    }]
                }
            }
        })

        /* PM25 */
        var pm25 = new Chart(document.getElementById('pm25'), {
            type: 'line',
            data: {
                labels: mergeLabels(data, 'pm25'),
                datasets: getDatasets(data, 'pm25', predictionOffset, enableHeavyComputing)
            },
            options: {
                legend: {
                    display: false
                },
                responsive: true,
                title: {
                    display: true,
                    text: 'PM2.5'
                },
                tooltips: {
                    mode: 'index',
                    intersect: true
                },
                annotation: {
                    annotations: [{
                        type: 'line',
                        mode: 'horizontal',
                        scaleID: 'y-axis-0',
                        value: data.pm25_norm,
                        borderColor: 'rgb(255, 0, 0)',
                        borderWidth: 2,
                        label: {
                            enabled: false,
                            content: 'Norm',
                            position: 'right'
                        }
                    }]
                },
                scales: {
                    xAxes: [{
                        type: 'time',
                        distribution: 'linear',
                        time: {
                            unit: 'day'
                        }
                    }],
                    yAxes: [{
                        scaleLabel: {
                            display: true,
                            labelString: 'PM2.5 (\xB5g/m\xB3)',
                            ticks: {
                                beginAtZero: true
                            }
                        },
                        ticks: {
                            beginAtZero: true
                        }
                    }]
                }
            }
        })

        /* PM10 */
        var pm10 = new Chart(document.getElementById('pm10'), {
            type: 'line',
            data: {
                labels: mergeLabels(data, 'pm10'),
                datasets: getDatasets(data, 'pm10', predictionOffset, enableHeavyComputing)
            },
            options: {
                legend: {
                    display: false
                },
                responsive: true,
                title: {
                    display: true,
                    text: 'PM10'
                },
                tooltips: {
                    mode: 'index',
                    intersect: true
                },
                annotation: {
                    annotations: [{
                        type: 'line',
                        mode: 'horizontal',
                        scaleID: 'y-axis-0',
                        value: data.pm10_norm,
                        borderColor: 'rgb(255, 0, 0)',
                        borderWidth: 2,
                        label: {
                            enabled: false,
                            content: 'Norm',
                            position: 'right'
                        }
                    }]
                },
                scales: {
                    xAxes: [{
                        type: 'time',
                        distribution: 'linear',
                        time: {
                            unit: 'day'
                        }
                    }],
                    yAxes: [{
                        scaleLabel: {
                            display: true,
                            labelString: 'PM10 (\xB5g/m\xB3)'
                        },
                        ticks: {
                            beginAtZero: true
                        }
                    }]
                }
            }
        })

        /* TEMPERATURE */
        var temperature = new Chart(document.getElementById('temperature'), {
            type: 'line',
            data: {
                labels: mergeLabels(data, 'temperature'),
                datasets: getDatasets(data, 'temperature', predictionOffset, enableHeavyComputing)
            },
            options: {
                legend: {
                    display: false
                },
                responsive: true,
                title: {
                    display: true,
                    text: 'Temperature'
                },
                tooltips: {
                    mode: 'index',
                    intersect: true
                },
                scales: {
                    xAxes: [{
                        type: 'time',
                        distribution: 'linear',
                        time: {
                            unit: 'day'
                        }
                    }],
                    yAxes: [{
                        scaleLabel: {
                            display: true,
                            labelString: 'Temperature (\xB0C)'
                        }
                    }]
                }
            }
        })

        /* PRESSURE */
        var pressure = new Chart(document.getElementById('pressure'), {
            type: 'line',
            data: {
                labels: mergeLabels(data, 'pressure'),
                datasets: getDatasets(data, 'pressure', predictionOffset, enableHeavyComputing)
            },
            options: {
                legend: {
                    display: false
                },
                responsive: true,
                title: {
                    display: true,
                    text: 'Pressure'
                },
                tooltips: {
                    mode: 'index',
                    intersect: true
                },
                scales: {
                    xAxes: [{
                        type: 'time',
                        distribution: 'linear',
                        time: {
                            unit: 'day'
                        }
                    }],
                    yAxes: [{
                        scaleLabel: {
                            display: true,
                            labelString: 'Pressure (hPa)'
                        }
                    }]
                }
            }
        })

        /* HUMIDITY */
        var humidity = new Chart(document.getElementById('humidity'), {
            type: 'bar',
            data: {
                labels: mergeLabels(data, 'humidity'),
                datasets: getDatasets(data, 'humidity', predictionOffset, enableHeavyComputing)
            },
            options: {
                legend: {
                    display: false
                },
                responsive: true,
                title: {
                    display: true,
                    text: 'Humidity'
                },
                tooltips: {
                    mode: 'index',
                    intersect: true
                },
                scales: {
                    xAxes: [{
                        type: 'time',
                        distribution: 'linear',
                        time: {
                            unit: 'day'
                        },
                        categoryPercentage: 1.0,
                        barPercentage: 1.0
                    }],
                    yAxes: [{
                        scaleLabel: {
                            display: true,
                            labelString: '% of humidity'
                        },
                        ticks: {
                            beginAtZero: true,
                            max: 100
                        }
                    }]
                }
            }
        })

        /* WIND SPEED */
        var wind_speed = new Chart(document.getElementById('wind_speed'), {
            type: 'line',
            data: {
                labels: mergeLabels(data, 'wind_speed'),
                datasets: getDatasets(data, 'wind_speed', predictionOffset, enableHeavyComputing)
            },
            options: {
                legend: {
                    display: false
                },
                responsive: true,
                title: {
                    display: true,
                    text: 'Wind speed'
                },
                tooltips: {
                    mode: 'index',
                    intersect: true
                },
                scales: {
                    xAxes: [{
                        type: 'time',
                        distribution: 'linear',
                        time: {
                            unit: 'day'
                        }
                    }],
                    yAxes: [{
                        scaleLabel: {
                            display: true,
                            labelString: 'Speed (m/s)'
                        },
                        ticks: {
                            beginAtZero: true
                        }
                    }]
                }
            }
        })

        /* WIND DIRECTION */
        var wind_degree = new Chart(document.getElementById('wind_degree'), {
            type: 'line',
            data: {

            },
            options: {
                responsive: true,
                title: {
                    display: true,
                    text: 'Wind direction'
                },
                tooltips: {
                    mode: 'index',
                    intersect: true
                },
                scales: {
                    xAxes: [{
                        display: false
                    }],
                    yAxes: [{
                        display: false
                    }]
                }
            }
        })

        /* CLOUDS */
        var clouds = new Chart(document.getElementById('clouds'), {
            type: 'bar',
            data: {
                labels: mergeLabels(data, 'clouds'),
                datasets: getDatasets(data, 'clouds', predictionOffset, enableHeavyComputing)
            },
            options: {
                legend: {
                    display: false
                },
                responsive: true,
                title: {
                    display: true,
                    text: 'Clouds'
                },
                tooltips: {
                    mode: 'index',
                    intersect: true
                },
                scales: {
                    xAxes: [{
                        type: 'time',
                        distribution: 'linear',
                        time: {
                            unit: 'day'
                        },
                        categoryPercentage: 1.0,
                        barPercentage: 1.0
                    }],
                    yAxes: [{
                        scaleLabel: {
                            display: true,
                            labelString: '% of cloudiness'
                        },
                        ticks: {
                            beginAtZero: true,
                            max: 100
                        }
                    }]
                }
            }
        })
    }

    function fillInfo(info) {
        document.getElementById('info').innerText = info.join('\n');
    }

    function fillStats(stats, name) {
        var table = document.getElementById(name);
        for (var factor in stats) {
            var row = table.insertRow();
            row.insertCell().appendChild(document.createTextNode(factor));
            row.insertCell().appendChild(document.createTextNode(stats[factor].mean));
            row.insertCell().appendChild(document.createTextNode(stats[factor].median));
            row.insertCell().appendChild(document.createTextNode(stats[factor].stdev));
        }
    }

    function enableButtons() {
        document.getElementById('btn-email').disabled = false;
        document.getElementById('btn-refresh').disabled = false;
        document.getElementById('btn-export').disabled = false;
        document.getElementById('btn-email').removeAttribute("disabled");
        document.getElementById('btn-refresh').removeAttribute("disabled");
        document.getElementById('btn-export').removeAttribute("disabled");
        addExportButtonHandler();
    }

    /* Helper functions */
    function getFullChartWidth() {
        return Math.max.apply(null, canvases.map(c => c.width));
    }

    function getFullChartHeight() {
        return canvases.filter(c => c.style.display != 'none').map(c => c.height).reduce((a, b) => a + b, 0);
    }

    function addExportButtonHandler() {
        var exportBtn = document.getElementById('btn-export');
        exportBtn.addEventListener('click', function (e) {
            var canvas = document.createElement('canvas');
            var ctx = canvas.getContext('2d');
            canvas.width = getFullChartWidth();
            canvas.height = getFullChartHeight();
            ctx.fillStyle = "white";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            var tempY = 0;
            for (var i = 0; i < canvases.length; i++) {
                if (canvases[i].style.display != 'none') {
                    ctx.drawImage(canvases[i], 0, tempY);
                    tempY = tempY + canvases[i].height;
                }
            }
            var dataUrl = canvas.toDataURL('image/png');
            exportBtn.href = dataUrl;
        });
    }
</script> {% endblock %}